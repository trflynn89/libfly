parameters:
  configuration: 'Debug'
  arch: 'x64'

jobs:
  - job: 'Linux_${{ parameters.configuration }}_${{ parameters.arch }}'
    pool:
      vmImage: 'Ubuntu-16.04'

    variables:
      CC: 'gcc-8'
      CXX: 'g++-8'

    steps:
    - template: setup.yml

    - script: |
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test
        sudo apt-get update
        sudo apt-get install -y $CC $CXX
      displayName: 'GCC'

    - ${{ if eq(parameters.arch, 'x86') }}:
      - script: |
          sudo apt-get install -y $CC-multilib $CXX-multilib
        displayName: 'GCC Multilib'

    - ${{ if eq(parameters.configuration, 'Debug') }}:
      - script: |
          make -j -C build/nix release=0 arch=${{ parameters.arch }} tests
        displayName: 'Test'

      - script: |
          (cd /tmp && curl -LO https://github.com/linux-test-project/lcov/releases/download/v1.14/lcov-1.14.tar.gz)
          (cd /tmp && tar -xf lcov-1.14.tar.gz)
          /tmp/lcov-1.14/bin/lcov --version
        displayName: 'LCOV'

      # Fix PATH to remove leading and trailing quotes, otherwise codecov fails
      # when it runs `find`, which thinks that PATH is relative.
      - script: |
          /tmp/lcov-1.14/bin/lcov --directory build/nix --capture --output-file coverage.info
          /tmp/lcov-1.14/bin/lcov --remove coverage.info '/usr/*' '*/test/*' --output-file coverage.info
          /tmp/lcov-1.14/bin/lcov --list coverage.info

          bash <(curl -s https://codecov.io/bash) -f coverage.info
        displayName: 'Coverage'

    - ${{ if eq(parameters.configuration, 'Release') }}:
      - script: |
          make -j -C build/nix release=1 arch=${{ parameters.arch }} libfly
        displayName: 'Build'

      - template: package.yml
        parameters:
          contents: 'build/nix/release-*/etc/libfly-*.tar.bz2'
