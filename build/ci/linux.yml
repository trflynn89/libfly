parameters:
  configuration: 'Debug'
  arch: 'x64'

jobs:
  - job: 'Linux_${{ parameters.configuration }}_${{ parameters.arch }}'

    pool:
      vmImage: 'Ubuntu-16.04'

    container:
      image: trflynn89/libfly:ubuntu1904_gcc9_qt513
      options: --cap-add SYS_PTRACE

    variables:
      release: ${{ int(eq(parameters.configuration, 'Release')) }}

    steps:
    - template: setup.yml

    - ${{ if eq(parameters.configuration, 'Debug') }}:
      - script: |
          make -j -C build/nix release=$(release) arch=${{ parameters.arch }} tests
        displayName: 'Test'

      - script: |
          lcov --capture --directory build/nix --output-file coverage
          lcov --remove coverage '/usr/*' '*/test/*' --output-file coverage
          lcov --list coverage

          bash <(curl -s https://codecov.io/bash) -f coverage
        displayName: 'Coverage'

    - ${{ if eq(parameters.configuration, 'Release') }}:
      - script: |
          make -j -C build/nix release=$(release) arch=${{ parameters.arch }} libfly
        displayName: 'Build'

      - template: package.yml
        parameters:
          contents: 'build/nix/release-*/etc/libfly-*.tar.bz2'

    - ${{ if eq(parameters.arch, 'x64') }}:
      - script: |
          make -j -C build/nix release=$(release) arch=${{ parameters.arch }} install
          (cd /opt && sudo tar -xzf Qt.tar.gz)
        displayName: 'Install'
        failOnStderr: true

      - script: |
          make -j -C examples/qt release=$(release) arch=${{ parameters.arch }} libfly_qt_example
          make -j -C examples/build release=$(release) arch=${{ parameters.arch }} libfly_build_example
        displayName: 'Examples'
        failOnStderr: true

    - ${{ if eq(parameters.arch, 'x86') }}:
      - script: |
          make -j -C build/nix release=$(release) arch=${{ parameters.arch }} install
        displayName: 'Install'
        failOnStderr: true

      - script: |
          make -j -C examples/build release=$(release) arch=${{ parameters.arch }} libfly_build_example
        displayName: 'Examples'
        failOnStderr: true


