parameters:
  configuration: 'Debug'
  arch: 'x64'

jobs:
  - job: 'Linux_${{ parameters.configuration }}_${{ parameters.arch }}'
    pool:
      vmImage: 'Ubuntu-16.04'

    steps:
    - script: |
        sudo apt-get install -y gcc-multilib g++-multilib
      condition: eq('${{ parameters.arch }}', 'x86')
      displayName: 'Dependencies'

    - template: setup.yml
      parameters:
        configuration: '${{ parameters.configuration }}'

    - script: |
        make -j -C build/nix release=0 arch=${{ parameters.arch }} libfly tests
      condition: eq('${{ parameters.configuration }}', 'Debug')
      displayName: 'Build'

    - script: |
        make -j -C build/nix release=1 arch=${{ parameters.arch }} libfly
      condition: eq('${{ parameters.configuration }}', 'Release')
      displayName: 'Build'

    - template: package.yml
      parameters:
        configuration: '${{ parameters.configuration }}'
        contents: 'build/nix/release-*/etc/libfly-*.tar.bz2'
