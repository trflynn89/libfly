parameters:
  configuration: 'Debug'
  arch: 'x64'

jobs:
  - job: 'Linux_${{ parameters.configuration }}_${{ parameters.arch }}'

    pool:
      vmImage: 'Ubuntu-16.04'

    # Build image with: sudo docker build --tag "trflynn89/libfly:ubuntu18_gcc8"
    container:
      image: trflynn89/libfly:ubuntu18_gcc8
      options: --cap-add SYS_PTRACE

    variables:
      CC: 'gcc-8'
      CXX: 'g++-8'
      GCOV: 'gcov-8'

    steps:
    - template: setup.yml

    - ${{ if eq(parameters.configuration, 'Debug') }}:
      - script: |
          make -j -C build/nix release=0 arch=${{ parameters.arch }} tests
        displayName: 'Test'

      - template: coverage.yml
        parameters:
          build_path: 'build/nix'
          gcov: '$GCOV'

    - ${{ if eq(parameters.configuration, 'Release') }}:
      - script: |
          make -j -C build/nix release=1 arch=${{ parameters.arch }} libfly
        displayName: 'Build'

      - template: package.yml
        parameters:
          contents: 'build/nix/release-*/etc/libfly-*.tar.bz2'
