parameters:
  configuration: 'Debug'
  arch: 'x64'

jobs:
  - job: 'Windows_${{ parameters.configuration }}_${{ parameters.arch }}'
    pool:
      vmImage: windows-2019

    steps:
    - template: setup.yml

    - task: VSBuild@1
      inputs:
        solution: 'build\win\libfly.sln'
        configuration: ${{ parameters.configuration }}
        platform: ${{ parameters.arch }}
        maximumCpuCount: true
      displayName: 'Build'

    - ${{ if eq(parameters.configuration, 'Release') }}:
      - task: PowerShell@2
        inputs:
          filePath: build\win\test.ps1
          arguments: -configuration ${{ parameters.configuration }} -arch ${{ parameters.arch }}
          failOnStderr: false
        displayName: 'Test'

      - task: PowerShell@2
        inputs:
          filePath: build\win\release.ps1
          arguments: -arch ${{ parameters.arch }}
        displayName: 'Package'

      - template: package.yml
        parameters:
          contents: 'build\win\Release\msvc\libfly-*.zip'
